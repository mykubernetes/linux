# 1.正则表达式语法

“正则表达式”描述在搜索文本正文时要匹配的一个或多个字符串。 该表达式可用作一个将字符模式与要搜索的字符串相匹配的模板。

正则表达式包括**普通字符**（例如，a 到 z 之间的字母）和**特殊字符**（称为“元字符”）。

## 1.1 普通字符

<table>
    <tr>
        <th width=40% >字符</th>
        <th width=60% >行为</th>
    </tr>
    <tr>
        <td>[abc]</td>
        <td>匹配a、b 或 c（简单类）</td>
    </tr>
    <tr>
        <td>abc</td>
        <td>匹配除了 a、b 或 c外的任何字符，（否定）</td>
    </tr>
    <tr>
        <td>[a-zA-Z]</td>
        <td>匹配a 到 z 或 A 到 Z，两头的字母包括在内（范围）</td>
    </tr>
    <tr>
        <td>[a-d[m-p]]</td>
        <td>匹配a 到 d 或 m 到 p：[a-dm-p]（并集）</td>
    </tr>
    <tr>
        <td>[a-z&&[def]]</td>
        <td>匹配d、e 或 f（交集）</td>
    </tr>
    <tr>
        <td>[a-z&& [^bc]]</td>
        <td>a 到 z，除了 b 和 c：[ad-z]（减去）</td>
    </tr>
    <tr>
        <td>[a-z&& [^m-p]]</td>
        <td>a 到 z，而非 m 到 p：[a-lq-z]（减去）</td>
    </tr>
</table>

## 1.2 边界匹配符

<table>
    <tr>
        <th width=30% >字符</th>
        <th width=70% >行为</th>
    </tr>
    <tr>
        <td>^</td>
        <td>行的开头</td>
    </tr>
    <tr>
        <td>$</td>
        <td>行的结尾</td>
    </tr>
    <tr>
        <td>\b</td>
        <td>单词边界</td>
    </tr>
    <tr>
        <td>\B</td>
        <td>非单词边界</td>
    </tr>
    <tr>
        <td>\A</td>
        <td>输入的开头</td>
    </tr>
    <tr>
        <td>\G</td>
        <td>上一个匹配的结尾</td>
    </tr>
    <tr>
        <td>\Z</td>
        <td>输入的结尾，仅用于最后的结束符（如果有的话）</td>
    </tr>
    <tr>
        <td>\z</td>
        <td>输入的结尾</td>
    </tr>
</table>


## 1.3 特殊字符

下表为**单字符元字符**的列表以及它们在正则表达式中的行为。

>  若要匹配这些特殊字符之一，必须首先转义字符，即，在字符前面加反斜杠字符 (\\)。 例如，若要搜索“+”文本字符，可使用表达式“\\+”。<br>

<table>
    <tr>
        <th width=10% >元字符</th>
        <th width=50% >行为</th>
        <th width=40% >示例</th>
    </tr>
    <tr>
        <td>*</td>
        <td>零次或多次匹配前面的字符或子表达式，等效于 {0,}。</td>
        <td>zo* 与“z”和“zoo”匹配。</td>
    </tr>
    <tr>
        <td>+</td>
        <td>一次或多次匹配前面的字符或子表达式,等效于 {1,}。</td>
        <td>zo+ 与“zo”和“zoo”匹配，但与“z”不匹配。</td>
    </tr>
    <tr>
        <td>?</td>
        <td>零次或一次匹配前面的字符或子表达式,等效于 {0,1}。</td>
        <td>zo? 与“z”和“zo”匹配，但与“zoo”不匹配。<br />o+? 只与“oooo”中的单个“o”匹配，而 o+ 与所有“o”匹配。<br />do(es)? 与“do”或“does”中的“do”匹配。</td>
    </tr>
    <tr>
        <td>^</td>
        <td>匹配搜索字符串开始的位置。 如果标志中包括 m（多行搜索）字符，^ 还将匹配 \n 或 \r 后面的位置。<br />如果将 ^ 用作括号表达式中的第一个字符，则会对字符集求反。</td>
        <td>^\d{3} 与搜索字符串开始处的 3 个数字匹配。<br />[^abc] 与除 a、b 和 c 以外的任何字符匹配。</td>
    </tr>
    <tr>
        <td>$</td>
        <td>匹配搜索字符串结尾的位置。 如果标志中包括 m（多行搜索）字符，^ 还将匹配 \n 或 \r 前面的位置。</td>
        <td>\d{3}$ 与搜索字符串结尾处的 3 个数字匹配。</td>
    </tr>
    <tr>
        <td>.</td>
        <td>匹配除换行符 \n 之外的任何单个字符。 若要匹配包括 \n 在内的任意字符，请使用诸如 [\s\S] 之类的模式。</td>
        <td>a.c 与“abc”、“a1c”和“a-c”匹配。</td>
    </tr>
    <tr>
        <td>[]</td>
        <td>标记括号表达式的开始和结尾。</td>
        <td>[1-4] 与“1”、“2”、“3”或“4”匹配。<br /> [^aAeEiIoOuU] 与任何非元音字符匹配。</td>
    </tr>
    <tr>
        <td>{}</td>
        <td>标记限定符表达式的开始和结尾。</td>
        <td>a{2,3} 与“aa”和“aaa”匹配。</td>
    </tr>
    <tr>
        <td>()</td>
        <td>标记子表达式的开始和结尾, 可以保存子表达式以备将来之用。</td>
        <td>A(\d) 与“A0”至“A9”匹配, 保存该数字以备将来之用。</td>
    </tr>
    <tr>
        <td>|</td>
        <td>指示在两个或多个项之间进行选择。</td>
        <td>z|food 与“z”或“food”匹配<br /> (z|f)ood 与“zood”或“food”匹配</td>
    </tr>
    <tr>
        <td>\</td>
        <td>将下一字符标记为特殊字符、文本、反向引用或八进制转义符。</td>
        <td>\n 与换行符匹配。 \( 与“(”匹配。 \\ 与“\”匹配。</td>
    </tr>
</table>


## 1.4 元字符

下表为**多字符元字符**的列表以及它们在正则表达式中的行为。

<table>
    <tr>
        <th width=10% >元字符</th>
        <th width=50% >行为</th>
        <th width=40% >示例</th>
    </tr>
    <tr>
        <td>\b</td>
        <td>与一个字边界匹配,即字与空格间的位置。</td>
        <td>er\b 与“never”中的“er”匹配，但与“verb”中的“er”不匹配。</td>
    </tr>
    <tr>
        <td>\B</td>
        <td>匹配非边界字符。</td>
        <td>er\B 与“verb”中的“er”匹配，但与“never”中的“er”不匹配。</td>
    </tr>
    <tr>
        <td>\d</td>
        <td>匹配数字字符，等效于 [0-9]。</td>
        <td>在搜索字符串“12 345”中，<br />\d{2} 与“12”和“34”匹配。 <br/>\d 与“1”、“2”、“3”、“4”和“5”匹配。</td>
    </tr>
    <tr>
        <td>\D</td>
        <td>匹配非数字字符，等效于 [^0-9]。</td>
        <td>\D+ 与“abc123 def”中的“abc”和“def”匹配。</td>
    </tr>
    <tr>
        <td>\w</td>
        <td>匹配字母、数字和下划线(A-Z、a-z、0-9 和_),等效于 [A-Za-z0-9_]。</td>
        <td>在搜索字符串“The quick brown fox…”中，\w+与“The”、“quick”、“brown”和“fox”匹配。</td>
    </tr>
    <tr>
        <td>\W</td>
        <td>与除 A-Z、a-z、0-9 和下划线以外的任意字符匹配，等效于 [^A-Za-z0-9_]。</td>
        <td>在搜索字符串“The quick brown fox…”中，\W+ 与“…”和所有空格匹配。</td>
    </tr>
    <tr>
        <td>[xyz]</td>
        <td>与任何一个指定字符匹配（字符集）</td>
        <td>[abc] 与“plain”中的“a”匹配。</td>
    </tr>
    <tr>
        <td>[^xyz]</td>
        <td>与未指定的任何字符匹配（反向字符集）</td>
        <td>[^abc] 与“plain”中的“p”、“l”、“i”和“n”匹配。</td>
    </tr>
    <tr>
        <td>[a-z]</td>
        <td>匹配指定范围内的任何字符（字符范围）</td>
        <td>[a-z] 与“a”到“z”范围内的任何小写字母字符匹配。</td>
    </tr>
    <tr>
        <td>[^a-z]</td>
        <td>与不在指定范围内的任何字符匹配（反向字符范围）</td>
        <td>[^a-z] 与不在范围“a”到“z”内的任何字符匹配。</td>
    </tr>
    <tr>
        <td>{n}</td>
        <td>正好匹配 n 次， n 是非负整数。</td>
        <td>o{2} 与“Bob”中的“o”不匹配，但与“food”中的两个“o”匹配。</td>
    </tr>
    <tr>
        <td>{n,}</td>
        <td>至少匹配 n 次， n 是非负整数。<br />* 与 {0,} 相等，+ 与 {1,} 相等。</td>
        <td>o{2,} 与“Bob”中的“o”不匹配，但与“foooood”中的所有“o”匹配。</td>
    </tr>
    <tr>
        <td>{n,m}</td>
        <td>匹配至少 n 次，至多 m 次。 n 和 m 是非负整数，其中 n <= m， 逗号和数字之间不能有空格。<br />? 与 {0,1} 相等。</td>
        <td>在搜索字符串“1234567”中，\d{1,3} 与“123”、“456”和“7”匹配。</td>
    </tr>
    <tr>
        <td>(模式)</td>
        <td>与模式 匹配并保存匹配项。若要匹配括号字符 ( )，请使用“\(”或者“\)”。</td>
        <td>(Chapter|Section) [1-9] 与“Chapter 5”匹配，保存“Chapter”以备将来之用。</td>
    </tr>
    <tr>
        <td>(?:模式)</td>
        <td>与模式 匹配，但不保存匹配项；即不会存储匹配项以备将来之用。 这对于用“or”字符 (|) 组合模式部件的情况很有用。</td>
        <td>industr(?:y|ies) 与 industry|industries 相等。</td>
    </tr>
    <tr>
        <td>(?=模式)</td>
        <td>正预测先行。 找到一个匹配项后，将在匹配文本之前开始搜索下一个匹配项。 不会保存匹配项以备将来之用。</td>
        <td>^(?=.*\d).{4,8}$ 对密码应用以下限制：其长度必须介于 4 到 8 个字符之间，并且必须至少包含一个数字。<br />在该模式中，.*\d 查找后跟有数字的任意多个字符。 对于搜索字符串“abc3qr”，这与“abc3”匹配。<br />从该匹配项之前（而不是之后）开始，.{4,8} 与包含 4-8 个字符的字符串匹配。 这与“abc3qr”匹配。<br />^ 和 $ 指定搜索字符串的开始和结束位置。 这将在搜索字符串包含匹配字符之外的任何字符时阻止匹配。</td>
    </tr>
    <tr>
        <td>(?!模式)</td>
        <td>负预测先行。 匹配与模式 不匹配的搜索字符串。 找到一个匹配项后，将在匹配文本之前开始搜索下一个匹配项。 不会保存匹配项以备将来之用。</td>
        <td>\b(?!th)\w+\b 与不以“th”开头的单词匹配。<br />在该模式中，\b 与一个字边界匹配。 对于搜索字符串“ quick ”，这与第一个空格匹配。 (?!th) 与非“th”字符串匹配。 这与“qu”匹配。<br />从该匹配项开始，\w+ 与一个字匹配。 这与“quick”匹配。</td>
    </tr>
    <tr>
        <td>\cx</td>
        <td>匹配 x 指示的控制字符。 x 的值必须在 A-Z 或 a-z 范围内。 如果不是这样，则假定 c 就是文本“c”字符本身。</td>
        <td>\cM 与 Ctrl+M 或一个回车符匹配。</td>
    </tr>
    <tr>
        <td>\xn</td>
        <td>匹配 n，此处的 n 是一个十六进制转义码。 十六进制转义码必须正好是两位数长。 允许在正则表达式中使用 ASCII 代码。</td>
        <td>\x41 与“A”匹配。 \x041 等效于后跟有“1”的“\x04”（因为 n 必须正好是两位数）。</td>
    </tr>
    <tr>
        <td>\num</td>
        <td>匹配 num，此处的 num 是一个正整数。 这是对已保存的匹配项的引用。</td>
        <td>(.)\1 与两个连续的相同字符匹配。</td>
    </tr>
    <tr>
        <td>\n</td>
        <td>标识一个八进制转义码或反向引用。 如果 \n 前面至少有 n 个捕获子表达式，那么 n 是反向引用。 否则，如果 n 是八进制数 (0-7)，那么 n 是八进制转义码。</td>
        <td>(\d)\1 与两个连续的相同数字匹配。</td>
    </tr>
    <tr>
        <td>\nm</td>
        <td>标识一个八进制转义码或反向引用。 如果 \nm 前面至少有 nm 个捕获子表达式，那么 nm 是反向引用。 如果 \nm 前面至少有 n 个捕获子表达式，则 n 是反向引用，后面跟有文本 m。 如果上述情况都不存在，当 n 和 m 是八进制数字 (0-7) 时，\nm 匹配八进制转义码 nm。</td>
        <td>\11 与制表符匹配。</td>
    </tr>
    <tr>
        <td>\nml</td>
        <td>当 n 是八进制数字 (0-3)，m 和 l 是八进制数字 (0-7) 时，匹配八进制转义码 nml。</td>
        <td>\011 与制表符匹配。</td>
    </tr>
    <tr>
        <td>\un</td>
        <td>匹配 n，其中 n 是以四位十六进制数表示的 Unicode 字符。</td>
        <td>\u00A9 与版权符号 (©) 匹配。</td>
    </tr>
</table>

## 1.5 非打印字符

下表为表示非打印字符的转义序列。

<table>
    <tr>
        <th width=10% >字符</th>
        <th width=50% >匹配</th>
        <th width=40% >等效于</th>
    </tr>
    <tr><td>\f</td><td>换页符</td><td>\x0c 和 \cL</td></tr>
    <tr><td>\n</td><td>换行符</td><td>\x0a 和 \cJ</td></tr>
    <tr><td>\r</td><td>回车符</td><td>\x0d 和 \cM</td></tr>
    <tr><td>\s</td><td>空白字符（包括空格、制表符和换页符）</td><td>[ \f\n\r\t\v]</td></tr>
    <tr><td>\S</td><td>非空白字符</td><td>[^ \f\n\r\t\v]</td></tr>
    <tr><td>\t</td><td>Tab 字符</td><td>\x09 和 \cI</td></tr>
    <tr><td>\v</td><td>垂直制表符</td><td>\x0b 和 \cK</td></tr>
</table>

## 1.6 优先级顺序

正则表达式的计算方式与算术表达式非常类似；即从左到右进行计算，并遵循优先级顺序。

下表按从高到低的顺序包含了正则表达式**运算符**的优先级顺序。

<table>
    <tr>
        <th width=50% >运算符</th>
        <th width=50% >说明</th>
    </tr>
    <tr><td>\</td><td>转义符</td></tr>
    <tr><td>(), (?:), (?=), []</td><td>括号和中括号</td></tr>
    <tr><td>*、+、?、{n}、{n,}、{n,m}</td><td>限定符</td></tr>
    <tr><td>^、$、\任何元字符</td><td>定位点和序列</td></tr>
    <tr><td>|</td><td>替换</td></tr>
</table>

**字符具有高于替换运算符的优先级**，例如，允许“m|food”匹配“m”或“food”。

## 1.7 匹配内容命名为一个字段

将匹配内容命名为一个字段。(?`<name>`Expression)可将与Expression格式匹配的内容保存到以name命名的字段里。
<br> **注意**：一个正则表达式中字段分组命名的字段不能重复。

## 1.8 标准Apache格式日志

对于标准Apache格式日志，可填入 **%{COMBINEDAPACHELOG}**进行规范解析。

## 1.9 修饰符Flag的用法

|flag|功能|
|---|---|
|CASE_INSENSITIVE(?i)|表示正则匹配的时候忽略大小写，US-ASCII 字符下进行。可以结合 UNICODE_CASE 的标记，基于 Unicode 的大小写不敏感的匹配就可以开启了|
|COMMENTS(?x)|空白和 #开始直到行末的注释会被忽略掉|
|DOTALL(?s)|这种模式下`.`可以匹配所有字符，包括换行符，默认`.`匹配除换行符以外的任意字符|
|MULTILINE(?m)|更改`^`和`$`的含义，以使它们分别与任何行的开头和结尾匹配，而不只是与整个字符串的开头和结尾匹配。 注意：(?m)只有在正则表达式中涉及到多行的`^`和`$`的匹配时，才使用 Multiline 模式。|
|UNIX_LINES(?d)|在`.`、`^`、`&`的行为中只识别换行符`\n`|
